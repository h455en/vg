<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vide-Greniers Scraper</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .container {
            max-width: 1200px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .selectable-row:hover {
            background-color: #e5e7eb;
            cursor: pointer;
        }

        .selectable-row.selected {
            background-color: #bfdbfe;
            --tw-ring-color: #1d4ed8;
            border: 2px solid;
            border-color: #1d4ed8;
        }

        .highlight-row {
            background-color: #fef9c3;
            /* A light yellow to highlight rows */
        }

        .sticky-header {
            position: sticky;
            top: 0;
            background-color: #1f2937;
            color: white;
            z-index: 10;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 p-8">
    <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg">
        <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-2">Vide-Greniers Scraper</h1>
        <p class="text-center text-gray-500 mb-6">Extracts, organizes, and displays event data from URLs.</p>

        <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-4">
            <input type="text" id="masterUrlInput"
                class="w-full md:w-2/3 p-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="Enter master URL">
            <button id="runScraperBtn"
                class="w-full md:w-1/3 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                Run Scraper
            </button>
            <button id="stopScraperBtn"
                class="w-full md:w-1/3 bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-red-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 hidden">
                Stop Scraper
            </button>
        </div>

        <div id="loadingIndicator" class="hidden flex items-center justify-center gap-2 text-gray-500 mb-8">
            <div class="loading-spinner"></div>
            <span>Scraping data...</span>
        </div>

        <div id="messageBox" class="hidden p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg"></div>

        <div class="space-y-8">
            <!-- Output Section -->
            <div id="outputSection" class="hidden">
                <div class="flex flex-col md:flex-row gap-8 mb-8">
                    <!-- Table View -->
                    <div class="w-full">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex justify-between items-center">
                            <span>Events Table</span>
                            <span id="lastUpdate" class="text-sm font-normal text-gray-500"></span>
                        </h2>
                        <div class="overflow-x-auto rounded-lg shadow-sm ring-1 ring-gray-900/5">
                            <table id="manifTable" class="min-w-full divide-y divide-gray-300">
                                <thead class="bg-gray-800 text-white sticky-header">
                                    <tr>
                                        <th scope="col" class="py-3.5 px-3 text-left text-sm font-semibold">Select</th>
                                        <th scope="col" class="py-3.5 px-3 text-left text-sm font-semibold">Titre</th>
                                        <th scope="col" class="py-3.5 px-3 text-left text-sm font-semibold">Exp</th>
                                        <th scope="col" class="py-3.5 px-3 text-left text-sm font-semibold">Ville</th>
                                        <th scope="col" class="py-3.5 px-3 text-left text-sm font-semibold">Adresse</th>
                                        <th scope="col" class="py-3.5 px-3 text-left text-sm font-semibold">Date</th>
                                    </tr>
                                </thead>
                                <tbody id="manifTableBody" class="divide-y divide-gray-200 bg-white">
                                    <!-- Table rows will be inserted here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Selected Rows Section -->
                <div class="mt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">Selected Rows</h2>
                        <div class="flex gap-2">
                            <button id="copyAddressesBtn"
                                class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-400 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                                Copy Addresses
                            </button>
                            <button id="copySelectedBtn"
                                class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-400 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                                Copy Summary
                            </button>
                        </div>
                    </div>
                    <textarea id="selectedRowsTextarea"
                        class="w-full h-40 p-4 border border-gray-300 rounded-lg bg-gray-50 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>

                <!-- Raw JSON Section -->
                <div class="mt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">Raw JSON Output</h2>
                        <button id="downloadJsonBtn"
                            class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                            Download JSON
                        </button>
                    </div>
                    <pre id="rawJsonOutput"
                        class="w-full h-80 p-4 bg-gray-800 text-gray-200 rounded-lg overflow-auto text-sm">
                        <!-- Raw JSON will be inserted here -->
                    </pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // The base URL for building links
        const baseUrl = "https://vide-greniers.org";
        // A simple CORS proxy to bypass fetch restrictions. Note that this can be unreliable.
        const proxyUrl = "https://corsproxy.io/?";

        // UI elements
        const masterUrlInput = document.getElementById('masterUrlInput');
        masterUrlInput.value = "https://vide-greniers.org/evenements/Paris-75"; // Set default value

        const runScraperBtn = document.getElementById('runScraperBtn');
        const stopScraperBtn = document.getElementById('stopScraperBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const outputSection = document.getElementById('outputSection');
        const manifTableBody = document.getElementById('manifTableBody');
        const rawJsonOutput = document.getElementById('rawJsonOutput');
        const downloadJsonBtn = document.getElementById('downloadJsonBtn');
        const selectedRowsTextarea = document.getElementById('selectedRowsTextarea');
        const copySelectedBtn = document.getElementById('copySelectedBtn');
        const copyAddressesBtn = document.getElementById('copyAddressesBtn');
        const lastUpdateSpan = document.getElementById('lastUpdate');

        let isScrapingStopped = false;

        function showMessage(message, isError = true) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            if (isError) {
                messageBox.classList.add('text-red-700', 'bg-red-100');
                messageBox.classList.remove('text-green-700', 'bg-green-100');
            } else {
                messageBox.classList.add('text-green-700', 'bg-green-100');
                messageBox.classList.remove('text-red-700', 'bg-red-100');
            }
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            const date = now.toLocaleDateString('fr-FR');
            const time = now.toLocaleTimeString('fr-FR', { hour12: false });
            lastUpdateSpan.textContent = `Last Update: ${date} ${time}`;
        }

        // Main function to orchestrate the scraping and display
        async function runScraper() {
            const masterUrl = masterUrlInput.value;
            runScraperBtn.disabled = true;
            runScraperBtn.classList.add('opacity-50', 'cursor-not-allowed');
            stopScraperBtn.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            outputSection.classList.add('hidden');
            messageBox.classList.add('hidden');
            manifTableBody.innerHTML = '';
            rawJsonOutput.textContent = '';
            selectedRowsTextarea.value = '';
            isScrapingStopped = false;
            updateLastUpdatedTime();

            try {
                console.log(`Starting scraper for master URL: ${masterUrl}`);
                // Find all event URLs on the master page first
                const eventUrls = await findEventUrls(masterUrl);
                console.log(`Found ${eventUrls.length} event URLs. Starting to scrape each one.`);

                // Scrape data from each found URL
                const manifs = await scrapeAllManifs(eventUrls);
                console.log("Scraping complete. Found data for:", manifs.length, "events.");

                // Group by date and sort by exposants
                const groupedManifs = groupByAndSort(manifs);
                console.log("Grouped and sorted Manifs:", groupedManifs);

                // Output to console and raw JSON area
                rawJsonOutput.textContent = JSON.stringify(groupedManifs, null, 2);

                // Populate the table
                populateTable(groupedManifs);

                outputSection.classList.remove('hidden');
                showMessage('Scraping successful! Data loaded into the table and JSON output.', false);

            } catch (error) {
                console.error("Failed to run scraper:", error);
                showMessage(`An error occurred during scraping: ${error.message}. Please check the console for details.`);
            } finally {
                runScraperBtn.disabled = false;
                runScraperBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                stopScraperBtn.classList.add('hidden');
                loadingIndicator.classList.add('hidden');
            }
        }

        function stopScraper() {
            isScrapingStopped = true;
            showMessage('Scraping stopped by user. Displaying current data.', false);
        }

        // Finds and returns all event links from a master page.
        async function findEventUrls(url) {
            console.log(`Fetching master URL: ${url}`);
            const proxyUrlWithTarget = `${proxyUrl}${encodeURIComponent(url)}`;
            const response = await fetch(proxyUrlWithTarget);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status} from ${proxyUrlWithTarget}`);
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            const links = Array.from(doc.querySelectorAll('a[href^="/evenement/"]'))
                .map(a => baseUrl + a.getAttribute('href'));

            console.log("URLs found on master page:", links);
            return links;
        }

        // Fetches and scrapes data for all URLs
        async function scrapeAllManifs(urls) {
            const manifs = [];
            for (const url of urls) {
                if (isScrapingStopped) {
                    break;
                }
                console.log(`Scraping event page: ${url}`);
                const manif = await scrapeManifData(url);
                if (manif) {
                    manifs.push(manif);
                }
            }
            return manifs;
        }

        // Groups manifs by date and sorts them
        function groupByAndSort(manifs) {
            const grouped = manifs.reduce((acc, manif) => {
                const date = manif.ManifDate;
                if (!acc[date]) {
                    acc[date] = [];
                }
                acc[date].push(manif);
                return acc;
            }, {});

            // Sort each group by 'Exposants' descending
            for (const date in grouped) {
                grouped[date].sort((a, b) => b.Exposants - a.Exposants);
            }

            return grouped;
        }

        // --- Core Scraping Functions ---
        async function scrapeManifData(url) {
            try {
                const proxyUrlWithTarget = `${proxyUrl}${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrlWithTarget);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const html = await response.text();

                // Regex patterns from user's suggestion
                const exposantsRegex = /(\d+)\s+exposants/;

                // Fallback to text-based search using user's regex if JSON-LD is not found or is incomplete
                const titleMatch = html.match(/<h1[^>]*>(.*?)<\/h1>/);
                const exposantsMatch = html.match(exposantsRegex);
                const addressMatch = html.match(/Adresse\s*:\s*<\/strong><br\/>(.*?)(?=<br)/);
                const dateMatch = html.match(/Le<\/strong> <span class=".*?">(.*?)<\/span>/);
                const cityMatch = html.match(/<strong>Ville<\/strong> : (.*?)<br\/>/);

                let title = titleMatch && titleMatch[1] ? titleMatch[1].trim() : 'N/A';
                let exposants = exposantsMatch && exposantsMatch[1] ? parseInt(exposantsMatch[1], 10) : -1;
                let adresse = addressMatch && addressMatch[1] ? addressMatch[1].trim() : 'N/A';
                let manifDate = dateMatch && dateMatch[1] ? dateMatch[1].trim() : 'N/A';
                let ville = cityMatch && cityMatch[1] ? cityMatch[1].trim() : 'N/A';

                const manif = {
                    Titre: title,
                    Exposants: exposants,
                    Ville: ville,
                    Adresse: adresse,
                    ManifDate: manifDate,
                    ManifLink: url
                };

                console.log("Successfully scraped:", manif);
                return manif;
            } catch (error) {
                console.error(`Failed to scrape ${url}:`, error);
                return null;
            }
        }

        // --- UI & Interaction Functions ---

        function populateTable(groupedManifs) {
            manifTableBody.innerHTML = '';
            for (const date in groupedManifs) {
                groupedManifs[date].forEach(manif => {
                    const row = document.createElement('tr');
                    row.classList.add('selectable-row', 'transition-colors', 'duration-200');
                    row.dataset.manif = JSON.stringify(manif);

                    // Add a highlight class if exposants is > 150
                    if (manif.Exposants > 150) {
                        row.classList.add('highlight-row');
                    }

                    // Truncate the title to 40 characters
                    const truncatedTitle = manif.Titre.length > 40 ? manif.Titre.substring(0, 40) + '...' : manif.Titre;

                    row.innerHTML = `
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600"></td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm font-medium text-gray-900"><a href="${manif.ManifLink}" target="_blank" class="text-blue-600 hover:underline">${truncatedTitle}</a></td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${manif.Exposants}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${manif.Ville}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${manif.Adresse}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${manif.ManifDate}</td>
                    `;
                    manifTableBody.appendChild(row);
                });
            }
        }

        // Event listener for "Copy to Text Area" button
        copySelectedBtn.addEventListener('click', () => {
            const selectedRows = document.querySelectorAll('#manifTableBody input[type="checkbox"]:checked');
            const selectedData = Array.from(selectedRows).map(checkbox => JSON.parse(checkbox.closest('tr').dataset.manif));
            const formattedText = selectedData.map(d =>
                `Title: ${d.Titre}\nDate: ${d.ManifDate}\nAddress: ${d.Adresse}, ${d.Ville}\nExposants: ${d.Exposants}\nLink: ${d.ManifLink}\n`
            ).join('\n');
            selectedRowsTextarea.value = formattedText;
        });

        // Event listener for "Copy Addresses" button
        copyAddressesBtn.addEventListener('click', () => {
            const selectedRows = document.querySelectorAll('#manifTableBody input[type="checkbox"]:checked');
            const selectedAddresses = Array.from(selectedRows).map(checkbox => {
                const data = JSON.parse(checkbox.closest('tr').dataset.manif);
                return `${data.Adresse}, ${data.Ville}`;
            }).join('\n');
            selectedRowsTextarea.value = selectedAddresses;
        });

        // Event listener for "Download JSON" button
        downloadJsonBtn.addEventListener('click', () => {
            const dataStr = rawJsonOutput.textContent;
            if (dataStr) {
                const blob = new Blob([dataStr], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'manifs.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        });

        // Add an event listener to the table body to handle checkbox clicks and row selection
        manifTableBody.addEventListener('change', (event) => {
            const checkbox = event.target;
            if (checkbox.type === 'checkbox') {
                const row = checkbox.closest('tr');
                if (checkbox.checked) {
                    row.classList.add('selected');
                } else {
                    row.classList.remove('selected');
                }
            }
        });

        runScraperBtn.addEventListener('click', runScraper);
        stopScraperBtn.addEventListener('click', stopScraper);
    </script>
</body>

</html>